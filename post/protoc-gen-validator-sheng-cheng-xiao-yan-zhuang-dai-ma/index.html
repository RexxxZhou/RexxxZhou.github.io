<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>protoc-gen-validator生成校验桩代码 | Rexxxx&#39;s Blog</title>
<meta name="description" content="Life is a fucking movie, enjoy.">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="https://rexxxzhou.github.io/favicon.ico?v=1678621911113">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/papercss@1.6.1/dist/paper.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://rexxxzhou.github.io/styles/main.css">


<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />


  </head>
  <body>
  
    <nav class="navbar border fixed split-nav">
  <div class="nav-brand">
    <h3><a href="https://rexxxzhou.github.io">Rexxxx&#39;s Blog</a></h3>
  </div>
  <div class="collapsible">
    <input id="collapsible1" type="checkbox" name="collapsible1">
    <button>
      <label for="collapsible1">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
      </label>
    </button>
    <div class="collapsible-body">
      <ul class="inline">
        
          <li>
            
              <a href="/" class="menu">
                首页
              </a>
            
          </li>
        
          <li>
            
              <a href="/archives" class="menu">
                归档
              </a>
            
          </li>
        
          <li>
            
              <a href="/tags" class="menu">
                标签
              </a>
            
          </li>
        
          <li>
            
              <a href="/post/about" class="menu">
                关于
              </a>
            
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div id="top" class="row site">
      <div class="sm-12 md-8 col">
        <div class="paper">
          <article class="article">
            <h1>protoc-gen-validator生成校验桩代码</h1>
            <p class="article-meta">
              2022-08-28
              
            </p>
            
            <div class="post-content" v-pre>
              <p>GitHub - envoyproxy/protoc-gen-validate: protoc plugin to generate polyglot message validators</p>
<p>PGV可以指定语言生成校验，readme也给出了规则的写法</p>
<p>protoc --proto_path=./ --cpp_out=./rex_test ./test2.proto --validate_out=&quot;lang=cc:./&quot;</p>
<p>proto文件需要import validate/validator.proto，才可以使用pgv的校验规则</p>
<p>使用pgv，可以在proto文件中对字段定义校验规则，他会对每个message对象都执行校验，在接口代码中，我们只需要include这个头文件，使用校验函数即可</p>
<pre><code class="language-javascript">syntax = &quot;proto3&quot;;

package examplepb;

import &quot;validate/validate.proto&quot;;

message Person {
  uint64 id    = 1 [(validate.rules).uint64.gt    = 999];

  string email = 2 [(validate.rules).string.email = true];

  string name  = 3 [(validate.rules).string = {
                      pattern:   &quot;^[^[0-9]A-Za-z]+( [^[0-9]A-Za-z]+)*$&quot;,
                      max_bytes: 256,
                   }];

  Location home = 4 [(validate.rules).message.required = true];

  message Location {
    double lat = 1 [(validate.rules).double = { gte: -90,  lte: 90 }];
    double lng = 2 [(validate.rules).double = { gte: -180, lte: 180 }];
  }
}
</code></pre>
<p>上面这个proto文件，pgv生成的桩代码为</p>
<pre><code class="language-javascript">// Code generated by protoc-gen-validate
// source: test2.proto
// DO NOT EDIT!!!
#include &quot;test2.pb.validate.h&quot;
#include &lt;google/protobuf/message.h&gt;
#include &lt;google/protobuf/util/time_util.h&gt;
#include &quot;re2/re2.h&quot;
namespace pgv {
namespace protobuf = google::protobuf;
namespace protobuf_wkt = google::protobuf;
namespace validate {
using std::string;
// define the regex for a UUID once up-front
const re2::RE2 _uuidPattern(
    &quot;^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{&quot;
    &quot;12}$&quot;);
pgv::Validator&lt;::examplepb::Person&gt; validator___examplepb__Person(
    static_cast&lt;bool (*)(const ::examplepb::Person&amp;, pgv::ValidationMsg*)&gt;(
        ::examplepb::Validate));
pgv::Validator&lt;::examplepb::Person_Location&gt;
    validator___examplepb__Person_Location(
        static_cast&lt;bool (*)(const ::examplepb::Person_Location&amp;,
                             pgv::ValidationMsg*)&gt;(::examplepb::Validate));
}  // namespace validate
}  // namespace pgv
namespace examplepb {
// Validate checks the field values on ::examplepb::Person with the rules
// defined in the proto definition for this message. If any rules are
// violated, the return value is false and an error message is written to the
// input string argument.
const re2::RE2 _Person_Name_Pattern(
    re2::StringPiece(&quot;^[^[0-9]A-Za-z]+( [^[0-9]A-Za-z]+)*$&quot;,
                     sizeof(&quot;^[^[0-9]A-Za-z]+( [^[0-9]A-Za-z]+)*$&quot;) - 1));
bool Validate(const ::examplepb::Person&amp; m, pgv::ValidationMsg* err) {
  (void)m;
  (void)err;
  if (m.id() &lt;= 999) {
    {
      std::ostringstream msg(&quot;invalid &quot;);
      msg &lt;&lt; &quot;PersonValidationError&quot;
          &lt;&lt; &quot;.&quot;
          &lt;&lt; &quot;Id&quot;;
      msg &lt;&lt; &quot;: &quot;
          &lt;&lt; &quot;value must be greater than 999&quot;;
      *err = msg.str();
      return false;
    }
  }
  throw pgv::UnimplementedException(
      &quot;C++ email address validation is not implemented&quot;);
  if (m.name().size() &gt; 256) {
    {
      std::ostringstream msg(&quot;invalid &quot;);
      msg &lt;&lt; &quot;PersonValidationError&quot;
          &lt;&lt; &quot;.&quot;
          &lt;&lt; &quot;Name&quot;;
      msg &lt;&lt; &quot;: &quot;
          &lt;&lt; &quot;value length must be at most 256 bytes&quot;;
      *err = msg.str();
      return false;
    }
  }
  {
    if (!RE2::FullMatch(re2::StringPiece(m.name().c_str(), m.name().size()),
                        _Person_Name_Pattern)) {
      {
        std::ostringstream msg(&quot;invalid &quot;);
        msg &lt;&lt; &quot;PersonValidationError&quot;
            &lt;&lt; &quot;.&quot;
            &lt;&lt; &quot;Name&quot;;
        msg &lt;&lt; &quot;: &quot;
            &lt;&lt; &quot;value does not match regex pattern \&quot;^[^[0-9]A-Za-z]+( &quot;
               &quot;[^[0-9]A-Za-z]+)*$\&quot;&quot;;
        *err = msg.str();
        return false;
      }
    }
  }
  if (!m.has_home()) {
    {
      std::ostringstream msg(&quot;invalid &quot;);
      msg &lt;&lt; &quot;PersonValidationError&quot;
          &lt;&lt; &quot;.&quot;
          &lt;&lt; &quot;Home&quot;;
      msg &lt;&lt; &quot;: &quot;
          &lt;&lt; &quot;value is required&quot;;
      *err = msg.str();
      return false;
    }
  }
  {
    pgv::ValidationMsg inner_err;
    if (m.has_home() &amp;&amp;
        !pgv::BaseValidator::AbstractCheckMessage(m.home(), &amp;inner_err)) {
      {
        std::ostringstream msg(&quot;invalid &quot;);
        msg &lt;&lt; &quot;PersonValidationError&quot;
            &lt;&lt; &quot;.&quot;
            &lt;&lt; &quot;Home&quot;;
        msg &lt;&lt; &quot;: &quot;
            &lt;&lt; &quot;embedded message failed validation&quot;;
        msg &lt;&lt; &quot; | caused by &quot; &lt;&lt; inner_err;
        *err = msg.str();
        return false;
      }
    }
  }
  return true;
}
// Validate checks the field values on ::examplepb::Person_Location with the
// rules defined in the proto definition for this message. If any rules are
// violated, the return value is false and an error message is written to the
// input string argument.
bool Validate(const ::examplepb::Person_Location&amp; m, pgv::ValidationMsg* err) {
  (void)m;
  (void)err;
  if (m.lat() &lt; -90 || m.lat() &gt; 90) {
    {
      std::ostringstream msg(&quot;invalid &quot;);
      msg &lt;&lt; &quot;LocationValidationError&quot;
          &lt;&lt; &quot;.&quot;
          &lt;&lt; &quot;Lat&quot;;
      msg &lt;&lt; &quot;: &quot;
          &lt;&lt; &quot;value must be inside range [-90, 90]&quot;;
      *err = msg.str();
      return false;
    }
  }
  if (m.lng() &lt; -180 || m.lng() &gt; 180) {
    {
      std::ostringstream msg(&quot;invalid &quot;);
      msg &lt;&lt; &quot;LocationValidationError&quot;
          &lt;&lt; &quot;.&quot;
          &lt;&lt; &quot;Lng&quot;;
      msg &lt;&lt; &quot;: &quot;
          &lt;&lt; &quot;value must be inside range [-180, 180]&quot;;
      *err = msg.str();
      return false;
    }
  }
  return true;
}
}  // namespace examplepb
</code></pre>
<p>生成的文件依赖有re2正则表达式库，以及依赖validate.h；前者基本上是内置的，后者是pgv生成的，所以编译时需要包含pgv源文件所在的validate目录，这个目录下才有这个头文件</p>
<p>上面的错误信息ValidationMsg，其实就是std::string，通过using声明的别名而已；</p>
<p>protoc-gen-validate/rule_comparison.md at main · envoyproxy/protoc-gen-validate · GitHub</p>
<p>pgv对于不同语言支持的情况</p>
<p>不同语言支持的规则特性不一样，所以上面有一个throw异常的情况，是因为c++没有实现这部分规则</p>
<p>go语言下的protoc编译命令，-I是告诉protoc，我们引用的validator.proto文件在哪里</p>
<pre><code class="language-javascript">protoc \
  -I . \
  -I ${GOPATH}/src \
  -I ${GOPATH}/src/github.com/envoyproxy/protoc-gen-validate \
  --go_out=&quot;:../generated&quot; \
  --validate_out=&quot;lang=go:../generated&quot; \
  example.proto
</code></pre>
<p>安装方法</p>
<pre><code class="language-javascript"># fetches this repo into $GOPATH
go get -d github.com/envoyproxy/protoc-gen-validate
# installs PGV into $GOPATH/bin
make build

# 或者
git clone https://github.com/envoyproxy/protoc-gen-validate.git
cd protoc-gen-validate/
make build
# 源代码自带protoc-gen-go二进制文件
# 如果没有go环境
# make时可以临时export GOPATH=/your/dir/protoc-gen-validate/
</code></pre>
<p>可以在Makefile中生成</p>
<pre><code class="language-javascript">.PHONY: validate
# generate validate proto
validate:
    protoc --proto_path=. \
           --cpp_out=./rex_test
           --validate_out=&quot;lang=cc:./&quot;
           $(API_PROTO_FILES)
           
    #protoc --proto_path=. \
    #       --proto_path=./third_party \
    #       --go_out=paths=source_relative:. \
    #       --validate_out=paths=source_relative,lang=go:. \
    #       $(API_PROTO_FILES)
</code></pre>

            </div>
          </article>
        </div>
        <div class="paper" data-aos="fade-in">
          
            <div class="next-post">
              <div class="next">
                下一篇
              </div>
              <a href="https://rexxxzhou.github.io/post/nginx-pei-zhi-xiang-jie/">
                <h3 class="post-title">
                  Nginx配置详解
                </h3>
              </a>
            </div>
          
        </div>
        
      </div>

      <div class="sm-12 md-4 col sidebar">
  <div class="paper info-container">
    <img src="https://rexxxzhou.github.io/images/avatar.png?v=1678621911113" class="no-responsive avatar">
    <div class="text-muted">Life is a fucking movie, enjoy.</div>
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      最新文章
    </div>
    <div class="row">
      <ul>
        
          
            <li>
              <a href="https://rexxxzhou.github.io/post/effectivego-bi-ji/">EffectiveGo笔记</a>
            </li>
          
        
          
            <li>
              <a href="https://rexxxzhou.github.io/post/go-yu-yan-wang-luo-kai-fa/">Go语言网络开发</a>
            </li>
          
        
          
            <li>
              <a href="https://rexxxzhou.github.io/post/go-yu-yan-shu-zu-yu-qie-pian/">Go语言数组与切片</a>
            </li>
          
        
          
            <li>
              <a href="https://rexxxzhou.github.io/post/go-yu-yan-lei-xing/">Go语言类型</a>
            </li>
          
        
          
            <li>
              <a href="https://rexxxzhou.github.io/post/go-yu-yan-kong-zhi-liu/">Go语言控制流</a>
            </li>
          
        
          
            <li>
              <a href="https://rexxxzhou.github.io/post/go-yu-yan-ji-chu-zhi-shi/">Go语言基础知识</a>
            </li>
          
        
          
            <li>
              <a href="https://rexxxzhou.github.io/post/go-yu-yan-han-shu/">Go语言函数</a>
            </li>
          
        
          
            <li>
              <a href="https://rexxxzhou.github.io/post/go-yu-yan-de-yi-xie-nei-zhi-han-shu/">Go语言的一些内置函数</a>
            </li>
          
        
          
            <li>
              <a href="https://rexxxzhou.github.io/post/go-yu-yan-cuo-wu-chu-li/">Go语言错误处理</a>
            </li>
          
        
          
            <li>
              <a href="https://rexxxzhou.github.io/post/go-yu-yan-bing-fa/">Go语言并发</a>
            </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      标签列表
    </div>
    <div class="row">
      
        <a href="https://rexxxzhou.github.io/tag/bzcKfnF8X/" class="badge ">
          Golang
        </a>
      
        <a href="https://rexxxzhou.github.io/tag/Jnf5LaxTP/" class="badge secondary">
          apue读书笔记
        </a>
      
        <a href="https://rexxxzhou.github.io/tag/hPjfg7vfX/" class="badge success">
          python
        </a>
      
        <a href="https://rexxxzhou.github.io/tag/fOn--vI2w/" class="badge secondary">
          日常开发知识沉淀
        </a>
      
        <a href="https://rexxxzhou.github.io/tag/ESBJ9vM7t/" class="badge warning">
          apisix
        </a>
      
        <a href="https://rexxxzhou.github.io/tag/R9r12TtWy/" class="badge success">
          lua
        </a>
      
        <a href="https://rexxxzhou.github.io/tag/MF20Z50u8/" class="badge warning">
          git
        </a>
      
        <a href="https://rexxxzhou.github.io/tag/e43sinOSt/" class="badge warning">
          MySQL
        </a>
      
        <a href="https://rexxxzhou.github.io/tag/m7J2bceGd/" class="badge ">
          HTTP
        </a>
      
        <a href="https://rexxxzhou.github.io/tag/m3a3xDoDi/" class="badge warning">
          ElasticSearch
        </a>
      
    </div>
  </div>
  <div class="paper">
    Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://rexxxzhou.github.io/atom.xml" target="_blank">RSS</a>
  </div>
</div>


    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

</script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5746490084885111"
     crossorigin="anonymous"></script>




  </body>
</html>
